# Vrachka — Списък с Подобрения и Поправки

Този файл описва всички препоръчителни подобрения и проверки, които да се изпълнят след текущите корекции (encoding, ENV/DEPLOY, CSP, cron-и).

## Визуално съдържание и локализация
- Преглед на кирилицата във всички UI компоненти и метаданни (извън вече оправените):
  - Проверете страници/компоненти в `components`, `app/(public|auth|dashboard|tarot|oracle|admin)` за остатъчен mojibake.
  - Уеднаквете термините („разтвор“, „четене“, „оракул“) из целия интерфейс.
- i18n стратегия (по избор):
  - Добавете поддръжка за EN с Next.js i18n или `next-intl`, разделяйки текстовете в JSON речници.
- A11y (достъпност):
  - Проверете `aria-*` атрибути, фокус и контраст. Добавете `aria-label` където е нужно (навигация, бутони, икони).

## Медия и SEO
- OG изображения:
  - Уверете се, че `public/og-image.png` съществува (1200x630, <500KB). В момента има инструкции, но файлът липсва.
  - Поддържайте и SVG източник, но сочете PNG в метаданните за по-добра съвместимост.
- Манифест и икони:
  - Потвърдете, че `public/icon-192.png`, `public/icon-512.png` и посочените `screenshots` съществуват.
- Sitemap/robots:
  - Сверете дали всички публични маршрути са включени и при нужда добавете нови страници.

## Сигурност
- CSP допълнително затягане:
  - Премахнато е `'unsafe-eval'`. Препоръчва се да се премахне и `'unsafe-inline'` чрез nonce/hash за inline скриптове.
  - Валидирайте външните домейни (GTM/GA/Stripe/Supabase/OpenRouter) и минимизирайте списъка.
- Cookies и заглавки:
  - Проверете SameSite/secure флагове на auth cookies (Supabase SSR конфигурация е ОК, прегледайте среда/production настройки).
- Логиране в middleware:
  - В `middleware.ts` има подробни `console.log` записи. В production ги ограничете (guard по `NODE_ENV`) или премахнете чувствителни данни.

## Плащания (Stripe)
- API версия:
  - В `lib/stripe.ts` `apiVersion` е нестандартна стойност. Ползвайте официална, напр. `2023-10-16` или премахнете опцията за автоматично актуална версия.
- Консолидация на цените:
  - В `app/api/checkout/route.ts` има дублиране на map за priceId; заменете с `PLAN_CONFIGS` и `getStripePriceId` за единен източник на истина.
- Валидиранe на валута:
  - Уверете се, че UI подава валута консистентно и че наличните цени са попълнени в ENV за BGN/EUR.

## Ограничаване на заявки (Rate limiting)
- Текущият in-memory limiter не е подходящ за serverless/множество инстанции.
  - Използвайте Upstash Redis или Supabase (виж `RATE_LIMITING.md`).
  - Добавете наблюдение и метрики за 429 отговори.

## Push известия и Service Worker
- Потвърдете пълния flow: subscribe → съхранение в `push_subscriptions` → изпращане от бекенд → показване в SW.
- Обновете CSP ако бекендът за push изпраща payloadи от различен домейн.
- Добавете UX състояния за (разрешено/забранено/неподдържано) и graceful fallback.

## Производителност
- Аналитики:
  - Зареждайте GA/Tag Manager с `next/script` и `strategy="afterInteractive"`/`lazyOnload`, ако не е така вече.
- Оптимизация на изображения:
  - Прегледайте големината на `.webp` таро изображенията и lazy-loading в компонентите.
- Lighthouse/CLS:
  - Проверете за layout shifts при навигация, особено в мобилната долна навигация.

## Тестване и качество на кода
- Линт/форматиране:
  - Добавете `.editorconfig`, ESLint и Prettier конфигурации, ако липсват; уеднаквете правила за импорти/стил.
- Тестове:
  - Unit тестове за core утилити/конфигурации (напр. `plans.ts`, rate limiting API).
  - Интеграционни тестове за auth, checkout и cron API.

## База данни (Supabase)
- Прегледайте RLS политики за новите таблици (push_subscriptions, subscriptions, профили) – най-малко права по подразбиране.
- Индекси и производителност:
  - Проверете наличието на индекси по често филтрирани полета (user_id, created_at, status).
- Миграции с бъдещи дати:
  - Прегледайте файловете с бъдещи timestamps (напр. `202510..`) за последователност и реално изпълнение.

## Админ/оперативност
- Audit trail:
  - Добавете auditing за админ действия (промяна на план, даване на trial, отменяне на абонамент) с таблица logs.
- Error monitoring:
  - Интегрирайте Sentry/Logflare или подобно за front/back.

## DevOps
- Cron-и във Vercel:
  - Синхронизирани са с наличните маршрути; валидирайте графиците според натоварването.
- Secrets управление:
  - Използвайте Vercel Encrypted Secrets/Env groups; прегледайте ротация на ключовете (Stripe/OpenRouter).

## Маркетинг и съдържание
- Страници „Privacy/Terms/Contact“:
  - Проверкa за актуалност и локализация (BG/EN), линкове от footer и sitemap.
- Копирайтинг на landing/CTA/Testimonials:
  - Преглед за консистентен тон и конкретни ползи; A/B идеи.

---

### Бързи задачи (чеклист)
- [ ] Добави `public/og-image.png` (1200x630) и тествай preview в социални мрежи
- [ ] Смени Stripe `apiVersion` с официална или премахни опцията
- [ ] Рефакторирай `app/api/checkout/route.ts` да ползва `PLAN_CONFIGS`
- [ ] Имплементирай Redis/Supabase rate limiting
- [ ] Премахни/ограничи production логовете в `middleware.ts`
- [ ] Добави nonce/hash и махни `'unsafe-inline'` в CSP (production)
- [ ] Добави `.editorconfig`, ESLint и Prettier конфигурация
- [ ] Провери наличност на икони и screenshots в `public/`
- [ ] Прегледай RLS политики и индекси по критичните таблици
- [ ] Добави Sentry/подобно за мониторинг
